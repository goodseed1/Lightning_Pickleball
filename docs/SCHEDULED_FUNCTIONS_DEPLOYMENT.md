# ğŸ“… Lightning Tennis Scheduled Functions Deployment Guide

## ğŸ¯ Overview

This guide covers the deployment and testing of Lightning Tennis's automated club schedule functions, specifically the **Weekly Event Generator** that automatically creates Lightning Events from club schedules every week.

## ğŸ—ï¸ Function Architecture

### Main Function: `generateWeeklyEvents`

- **Schedule**: Every Sunday at midnight (00:00 EST/EDT)
- **Purpose**: Read all active club schedules and generate corresponding Lightning Events for the next week
- **Location**: `functions/src/scheduledFunctions/weeklyEventGenerator.js`
- **Type**: Pub/Sub scheduled function
- **Timezone**: `America/New_York`

### Supporting Functions:

1. **`generateWeeklyEventsManual`** - HTTP trigger for manual testing
2. **`weeklyEventGeneratorHealth`** - Health check endpoint

## ğŸ“¦ Prerequisites

### 1. Firebase Project Setup

```bash
# Install Firebase CLI if not already installed
npm install -g firebase-tools

# Login to Firebase
firebase login

# Initialize Firebase Functions (if not already done)
firebase init functions
```

### 2. Project Configuration

Ensure these files are properly configured:

- `functions/package.json` - Dependencies
- `functions/tsconfig.json` - TypeScript configuration
- `firebase.json` - Firebase project configuration
- `.firebaserc` - Project aliases

### 3. Required Dependencies

The function uses the following npm packages:

```json
{
  "firebase-functions": "^4.x.x",
  "firebase-admin": "^11.x.x"
}
```

## ğŸš€ Deployment Steps

### Step 1: Build and Deploy

```bash
# Navigate to the functions directory
cd functions

# Install dependencies
npm install

# Build TypeScript (if using TS)
npm run build

# Deploy all functions
firebase deploy --only functions

# Or deploy specific functions
firebase deploy --only functions:generateWeeklyEvents,functions:generateWeeklyEventsManual,functions:weeklyEventGeneratorHealth
```

### Step 2: Verify Deployment

After deployment, check the Firebase Console:

1. Go to **Functions** section
2. Verify the functions are listed:
   - `generateWeeklyEvents`
   - `generateWeeklyEventsManual`
   - `weeklyEventGeneratorHealth`

### Step 3: Check Scheduler

1. Go to **Google Cloud Console** > **Cloud Scheduler**
2. Look for the scheduled job: `firebase-schedule-generateWeeklyEvents-us-central1`
3. Verify the schedule: `0 0 * * 0` (every Sunday at midnight)

## ğŸ§ª Testing Guide

### 1. Health Check Test

```bash
# Test health endpoint
curl https://us-central1-YOUR_PROJECT_ID.cloudfunctions.net/weeklyEventGeneratorHealth

# Expected response:
{
  "status": "healthy",
  "function": "generateWeeklyEvents",
  "schedule": "0 0 * * 0",
  "timezone": "America/New_York",
  "lastModified": "2025-08-11",
  "version": "1.0.0"
}
```

### 2. Manual Trigger Test

```bash
# Trigger manual execution
curl -X POST https://us-central1-YOUR_PROJECT_ID.cloudfunctions.net/generateWeeklyEventsManual

# Expected response:
{
  "success": true,
  "message": "Weekly events generated successfully",
  "result": {
    "success": true,
    "eventsCreated": 5,
    "schedulesProcessed": 3,
    "errors": 0
  }
}
```

### 3. Test Data Setup

Before testing, ensure you have test data:

```javascript
// Example test club schedule in Firestore
// Collection: clubSchedules
{
  clubId: "test-club-1",
  title: "Wednesday Evening Practice",
  scheduleType: "practice",
  dayOfWeek: 3, // Wednesday
  time: "19:00",
  duration: 120,
  timezone: "America/New_York",
  location: {
    name: "Central Park Tennis Courts",
    address: "Central Park, New York, NY",
    indoorOutdoor: "outdoor"
  },
  participationInfo: {
    maxParticipants: 12,
    minParticipants: 4,
    registrationRequired: true,
    memberOnly: true
  },
  recurrence: {
    frequency: "weekly",
    interval: 1,
    startDate: Timestamp.now()
  },
  isActive: true,
  createdBy: "test-admin-user",
  createdAt: Timestamp.now(),
  updatedAt: Timestamp.now()
}
```

### 4. Verify Event Creation

After running the function:

1. Check the `events` collection in Firestore
2. Look for events with:
   - `type: 'meetup'`
   - `tags: ['ì •ê¸°ëª¨ì„', 'regular_meeting']`
   - `autoGenerated: true`
   - `scheduleId` matching your club schedule

## ğŸ“Š Monitoring and Logging

### 1. Function Logs

View logs in Firebase Console or Cloud Logging:

```bash
# View logs using Firebase CLI
firebase functions:log --only generateWeeklyEvents --limit 50

# View logs using gcloud CLI
gcloud logging read "resource.type=cloud_function AND resource.labels.function_name=generateWeeklyEvents" --limit=50 --format=json
```

### 2. Execution History

The function stores execution logs in Firestore:

- Collection: `functionLogs`
- Document: `weeklyEventGenerator`
- Subcollection: `executions`

Example log entry:

```json
{
  "executedAt": "2025-08-18T00:00:00Z",
  "weekRange": {
    "startDate": "2025-08-18T00:00:00Z",
    "endDate": "2025-08-24T23:59:59Z"
  },
  "schedulesProcessed": 3,
  "eventsCreated": 5,
  "errors": 0,
  "results": [
    {
      "scheduleId": "schedule123",
      "clubId": "club456",
      "eventsCreated": 1,
      "success": true
    }
  ]
}
```

### 3. Error Monitoring

Monitor for errors:

- Check Cloud Functions logs for error messages
- Set up alerting for function failures
- Monitor execution logs in Firestore for error patterns

### 4. Performance Metrics

Track function performance:

- **Execution Time**: Should be under 60 seconds for normal loads
- **Memory Usage**: Monitor for memory leaks
- **Success Rate**: Aim for 99%+ success rate
- **Events Created**: Track weekly event generation volume

## ğŸ”§ Troubleshooting

### Common Issues

#### 1. Permission Errors

```bash
Error: HTTP Error: 403, The caller does not have permission
```

**Solution**: Ensure Firebase project has proper IAM roles:

- Cloud Functions Admin
- Cloud Scheduler Admin
- Pub/Sub Admin

#### 2. Timeout Issues

```bash
Error: Function execution timeout
```

**Solution**: Optimize the function or increase timeout:

```javascript
exports.generateWeeklyEvents = functions
  .runWith({ timeoutSeconds: 540 }) // 9 minutes
  .pubsub.schedule('0 0 * * 0')
  .onRun(async context => {
    // Function logic
  });
```

#### 3. No Schedules Found

Check the Firestore query:

- Verify `clubSchedules` collection exists
- Ensure documents have `isActive: true`
- Check indexing for the query

#### 4. Events Not Created

Verify:

- `events` collection write permissions
- Event data validation
- Date calculations for next week

### Debug Mode

Enable debug logging:

```javascript
// In weeklyEventGenerator.js
const DEBUG_MODE = process.env.NODE_ENV !== 'production';

if (DEBUG_MODE) {
  console.log('ğŸ› Debug mode enabled');
  console.log('ğŸ“Š Schedule data:', schedule);
  console.log('ğŸ“… Event data:', eventData);
}
```

## ğŸ”„ Maintenance

### Regular Tasks

1. **Weekly Monitoring**: Check function execution every Sunday
2. **Monthly Review**: Analyze execution logs and performance
3. **Quarterly Updates**: Update dependencies and security patches

### Scaling Considerations

- **High Volume**: Consider batching for 100+ club schedules
- **Global Expansion**: Add timezone handling for multiple regions
- **Performance**: Implement caching for frequently accessed data

### Backup Strategy

- Function code is in Git repository
- Firestore data has automatic backups
- Consider manual backups before major updates

## ğŸ“ Support and Maintenance

### Key Contacts

- **Development Team**: Lightning Tennis Dev Team
- **Firebase Support**: Google Cloud Support (if enterprise)
- **On-call Engineer**: Check team rotation schedule

### Emergency Procedures

1. **Function Failure**: Use manual trigger to catch up on missed executions
2. **Data Corruption**: Restore from Firestore backups
3. **Performance Issues**: Scale resources or disable temporarily

---

## ğŸ“‹ Deployment Checklist

- [ ] Firebase CLI installed and authenticated
- [ ] Functions dependencies installed (`npm install`)
- [ ] TypeScript compiled successfully (`npm run build`)
- [ ] Functions deployed (`firebase deploy --only functions`)
- [ ] Health check endpoint responsive
- [ ] Manual trigger test successful
- [ ] Test club schedules created in Firestore
- [ ] Test event generation verified
- [ ] Cloud Scheduler job created and active
- [ ] Monitoring and alerting configured
- [ ] Documentation updated and shared with team
- [ ] Production deployment scheduled and communicated

## ğŸ‰ Success Criteria

The deployment is successful when:

1. âœ… All three functions are deployed and accessible
2. âœ… Health check returns 200 OK status
3. âœ… Manual trigger creates events correctly
4. âœ… Scheduled execution runs on time (next Sunday)
5. âœ… Events are created in Firestore with correct data
6. âœ… No errors in function logs
7. âœ… Performance metrics are within acceptable ranges

**Congratulations! Your Lightning Tennis scheduled event generation system is now live! ğŸ¾**
